# scheduler.py - Tá»± Ä‘á»™ng Ä‘Äƒng bÃ i Ä‘Ãºng giá» tá»« scheduled_posts.csv
import time
import csv
from datetime import datetime
import requests
import os

SCHEDULE_FILE = "scheduled_posts.csv"
CHECK_INTERVAL = 60  # giÃ¢y

print("âœ… Scheduler khá»Ÿi cháº¡y...")

while True:
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    new_rows = []
    posted = False

    with open(SCHEDULE_FILE, "r", encoding="utf-8") as f:
        rows = list(csv.reader(f))

    for row in rows:
        if len(row) < 6:
            continue  # Bá» qua dÃ²ng lá»—i

        caption, platform, post_time, token, page_id, mode = row
        if mode == "Tá»± Ä‘á»™ng Ä‘Ãºng giá»" and post_time == now:
            print(f"ğŸš€ Äang Ä‘Äƒng: {caption[:30]}...")
            res = requests.post(
                f"https://graph.facebook.com/{page_id}/feed",
                data={"message": caption, "access_token": token})
            if res.status_code == 200:
                print("âœ… ÄÄƒng thÃ nh cÃ´ng")
                posted = True
            else:
                print(f"âŒ Lá»—i khi Ä‘Äƒng: {res.text}")
                new_rows.append(row)  # Giá»¯ láº¡i Ä‘á»ƒ thá»­ láº¡i sau
        else:
            new_rows.append(row)  # KhÃ´ng Ä‘áº¿n giá» hoáº·c khÃ´ng á»Ÿ cháº¿ Ä‘á»™ auto

    if posted:
        with open(SCHEDULE_FILE, "w", encoding="utf-8", newline="") as f:
            csv.writer(f).writerows(new_rows)

    time.sleep(CHECK_INTERVAL)
