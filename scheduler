# app.py
import streamlit as st
import requests
import csv
from datetime import datetime
from openai import OpenAI

st.set_page_config(page_title="AI Content Scheduler", layout="centered")
st.title("ğŸ¤– AI Agent táº¡o & quáº£n lÃ½ bÃ i Ä‘Äƒng")

# --- Nháº­p ná»™i dung Ä‘áº§u vÃ o ---
product_name = st.text_input("ğŸ“¦ TÃªn sáº£n pháº©m")
keywords = st.text_input("ğŸ” Tá»« khÃ³a mÃ´ táº£")
platform = st.selectbox("ğŸŒ Ná»n táº£ng", ["Facebook"])

# --- Sinh ná»™i dung báº±ng AI ---
if st.button("âœ¨ Táº¡o caption báº±ng AI"):
    prompt = f"""
    Báº¡n lÃ  chuyÃªn gia ná»™i dung sÃ¡ng táº¡o cho thÆ°Æ¡ng hiá»‡u gá»‘m thá»§ cÃ´ng cao cáº¥p.

    HÃ£y viáº¿t má»™t bÃ i viáº¿t marketing dÃ i khoáº£ng 100â€“150 tá»« phÃ¹ há»£p Ä‘Äƒng trÃªn {platform}, Ä‘á»ƒ giá»›i thiá»‡u sáº£n pháº©m {product_name}, sá»­ dá»¥ng cÃ¡c tá»« khÃ³a: {keywords}.

    YÃªu cáº§u:
    - Giá»ng vÄƒn má»™c máº¡c, truyá»n cáº£m há»©ng
    - Lá»“ng ghÃ©p cáº£m xÃºc, triáº¿t lÃ½ sá»‘ng cháº­m
    - KhÃ´ng quÃ¡ bÃ¡n hÃ ng. Gá»£i cáº£m giÃ¡c, cáº£m há»©ng sá»‘ng
    - Gáº¯n hashtag há»£p lÃ½ cuá»‘i bÃ i
    """

    try:
        client = OpenAI()
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.95
        )
        generated_caption = response.choices[0].message.content.strip()
        st.session_state.caption = generated_caption
        st.success("âœ… ÄÃ£ táº¡o ná»™i dung")
        st.text_area("ğŸ“ Caption Ä‘Æ°á»£c táº¡o:", generated_caption, height=200)
    except Exception as e:
        st.error(f"âŒ Lá»—i khi gá»i GPT: {e}")

# --- Náº¿u Ä‘Ã£ cÃ³ caption ---
if "caption" in st.session_state:
    st.subheader("ğŸ“¤ ÄÄƒng bÃ i")

    access_token = st.text_input("ğŸ” Access Token", type="password")
    page_id = st.text_input("ğŸ”‘ Facebook Page ID")

    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸš€ ÄÄƒng ngay lÃªn Facebook"):
            response = requests.post(
                f"https://graph.facebook.com/{page_id}/feed",
                data={"message": st.session_state.caption, "access_token": access_token}
            )
            if response.status_code == 200:
                st.success("âœ… ÄÃ£ Ä‘Äƒng bÃ i thÃ nh cÃ´ng!")
            else:
                st.error(f"âŒ Lá»—i khi Ä‘Äƒng: {response.text}")

    with col2:
        st.markdown("### ğŸ“… LÃªn lá»‹ch Ä‘Äƒng")
        selected_date = st.date_input("NgÃ y Ä‘Äƒng", value=datetime.today())
        selected_time = st.time_input("Giá» Ä‘Äƒng", value=datetime.now().time())
        post_mode = st.radio("ğŸ“Œ Chá»n cháº¿ Ä‘á»™ Ä‘Äƒng", ["ğŸ“… Tá»± Ä‘á»™ng Ä‘Äƒng Ä‘Ãºng giá»", "ğŸ‘€ Chá» duyá»‡t & Ä‘Äƒng thá»§ cÃ´ng"], horizontal=True)

        if st.button("âœ… XÃ¡c nháº­n & LÆ°u bÃ i"):
            scheduled_datetime = datetime.combine(selected_date, selected_time).strftime("%Y-%m-%d %H:%M")
            row = [st.session_state.caption, platform, scheduled_datetime, access_token, page_id, post_mode]

            if post_mode == "ğŸ“… Tá»± Ä‘á»™ng Ä‘Äƒng Ä‘Ãºng giá»":
                with open("scheduled_posts.csv", "a", newline="", encoding="utf-8") as f:
                    writer = csv.writer(f)
                    writer.writerow(row)
                st.success(f"âœ… ÄÃ£ lÃªn lá»‹ch Ä‘Äƒng lÃºc {scheduled_datetime}")
            else:
                with open("pending_posts.csv", "a", newline="", encoding="utf-8") as f:
                    writer = csv.writer(f)
                    writer.writerow(row)
                st.success("ğŸ“¥ BÃ i Ä‘Ã£ lÆ°u vÃ o danh sÃ¡ch chá» duyá»‡t")
