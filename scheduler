# scheduler.py - Tự động đăng bài đúng giờ từ scheduled_posts.csv
import time
import csv
from datetime import datetime
import requests
import os

SCHEDULE_FILE = "scheduled_posts.csv"
CHECK_INTERVAL = 60  # giây

print("✅ Scheduler khởi chạy...")

while True:
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    new_rows = []
    posted = False

    with open(SCHEDULE_FILE, "r", encoding="utf-8") as f:
        rows = list(csv.reader(f))

    for row in rows:
        if len(row) < 6:
            continue  # Bỏ qua dòng lỗi

        caption, platform, post_time, token, page_id, mode = row
        if mode == "Tự động đúng giờ" and post_time == now:
            print(f"🚀 Đang đăng: {caption[:30]}...")
            res = requests.post(
                f"https://graph.facebook.com/{page_id}/feed",
                data={"message": caption, "access_token": token})
            if res.status_code == 200:
                print("✅ Đăng thành công")
                posted = True
            else:
                print(f"❌ Lỗi khi đăng: {res.text}")
                new_rows.append(row)  # Giữ lại để thử lại sau
        else:
            new_rows.append(row)  # Không đến giờ hoặc không ở chế độ auto

    if posted:
        with open(SCHEDULE_FILE, "w", encoding="utf-8", newline="") as f:
            csv.writer(f).writerows(new_rows)

    time.sleep(CHECK_INTERVAL)
