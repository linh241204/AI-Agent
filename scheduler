import csv
from datetime import datetime, timedelta
import os
import requests
from dotenv import load_dotenv
from openai import OpenAI, OpenAIError

load_dotenv()

client = OpenAI(
    api_key=os.getenv("OPENROUTER_API_KEY"),
    base_url="https://openrouter.ai/api/v1"
)

SCHEDULED_FILE = "scheduled_posts.csv"

def generate_caption(product, keywords, platform):
    prompt = f"""
B·∫°n l√† chuy√™n gia n·ªôi dung s√°ng t·∫°o cho th∆∞∆°ng hi·ªáu g·ªëm th·ªß c√¥ng cao c·∫•p.

H√£y vi·∫øt m·ªôt **b√†i vi·∫øt marketing d√†i kho·∫£ng 100‚Äì150 t·ª´** ph√π h·ª£p ƒëƒÉng tr√™n {platform}, ƒë·ªÉ gi·ªõi thi·ªáu s·∫£n ph·∫©m **{product}**, s·ª≠ d·ª•ng tinh t·∫ø c√°c t·ª´ kh√≥a: {keywords}.

Y√™u c·∫ßu:
- Gi·ªçng vƒÉn m·ªôc m·∫°c, s√¢u s·∫Øc, truy·ªÅn c·∫£m h·ª©ng
- L·ªìng gh√©p c·∫£m x√∫c, tri·∫øt l√Ω s·ªëng ch·∫≠m, y√™u n√©t ƒë·∫πp truy·ªÅn th·ªëng
- Kh√¥ng qu√° b√°n h√†ng. T·∫≠p trung g·ª£i c·∫£m gi√°c, kh√¥ng gian, c·∫£m x√∫c ng∆∞·ªùi d√πng
- C√≥ th·ªÉ m·ªü ƒë·∫ßu b·∫±ng m·ªôt h√¨nh ·∫£nh ho·∫∑c c·∫£m nh·∫≠n ƒë·ªùi th∆∞·ªùng
- K·∫øt b√†i nh·∫π nh√†ng, c√≥ th·ªÉ ƒë·∫∑t c√¢u h·ªèi g·ª£i m·ªü
- G·∫Øn hashtag cu·ªëi b√†i. Kh√¥ng li·ªát k√™ hashtag qu√° d√†i

Vi·∫øt 1 b√†i duy nh·∫•t.
"""
    try:
        response = client.chat.completions.create(
            model="openai/gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.95
        )
        return response.choices[0].message.content.strip()
    except OpenAIError as e:
        return f"‚ö†Ô∏è L·ªói GPT: {e}"

def post_to_facebook(caption, token, page_id):
    url = f"https://graph.facebook.com/{page_id}/feed"
    params = {
        "message": caption,
        "access_token": token
    }
    response = requests.post(url, params=params)
    return response.status_code == 200

def run_scheduler():
    if not os.path.exists(SCHEDULED_FILE):
        print("‚ö†Ô∏è Ch∆∞a c√≥ file scheduled_posts.csv")
        return

    new_rows = []
    now = datetime.now()

    with open(SCHEDULED_FILE, "r", encoding="utf-8") as file:
        reader = csv.reader(file)
        for row in reader:
            if len(row) < 7:
                continue  # B·ªè qua d√≤ng l·ªói
            product, keywords, platform, time_str, token, page_id, repeat = row
            post_time = datetime.strptime(time_str, "%H:%M")
            today_post_time = now.replace(hour=post_time.hour, minute=post_time.minute, second=0, microsecond=0)

            if now >= today_post_time and now < today_post_time + timedelta(minutes=3):
                print(f"üìù ƒêang sinh n·ªôi dung cho {product}...")
                caption = generate_caption(product, keywords, platform)
                print(f"‚è∞ ƒêƒÉng b√†i l√∫c {today_post_time.strftime('%H:%M')}...")
                success = post_to_facebook(caption, token, page_id)
                if success:
                    print("‚úÖ ƒêƒÉng th√†nh c√¥ng!")
                else:
                    print("‚ùå L·ªói ƒëƒÉng b√†i.")

            new_rows.append(row)  # Lu√¥n gi·ªØ l·∫°i ƒë·ªÉ l·∫∑p m·ªói ng√†y

    with open(SCHEDULED_FILE, "w", encoding="utf-8", newline="") as file:
        writer = csv.writer(file)
        writer.writerows(new_rows)

if __name__ == "__main__":
    run_scheduler()
