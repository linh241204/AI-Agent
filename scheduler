# scheduler.py
import csv
import time
import requests
from datetime import datetime

def post_to_facebook(message, page_id, access_token):
    url = f"https://graph.facebook.com/{page_id}/feed"
    data = {"message": message, "access_token": access_token}
    r = requests.post(url, data=data)
    return r.status_code == 200, r.text

print("🚀 Đang chạy Scheduler...\n")

while True:
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    remaining_rows = []

    try:
        with open("scheduled_posts.csv", "r", encoding="utf-8") as f:
            reader = csv.reader(f)
            for row in reader:
                if len(row) < 6:
                    continue
                caption, platform, scheduled_time, token, page_id, mode = row
                if scheduled_time == now and mode == "📅 Tự động đăng đúng giờ":
                    print(f"⏰ {now} - Đang đăng bài...")
                    success, resp = post_to_facebook(caption, page_id, token)
                    if success:
                        print("✅ Đã đăng bài thành công")
                    else:
                        print(f"❌ Lỗi khi đăng bài: {resp}")
                else:
                    remaining_rows.append(row)

        with open("scheduled_posts.csv", "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerows(remaining_rows)

    except FileNotFoundError:
        print("📂 Chưa có file scheduled_posts.csv. Đợi bài mới...")

    time.sleep(60)
