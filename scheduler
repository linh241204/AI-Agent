import csv
import time
import requests
from datetime import datetime

CSV_FILE = "scheduled_posts.csv"

def post_caption_to_facebook(page_id, access_token, caption):
    url = f"https://graph.facebook.com/v19.0/{page_id}/feed"
    data = {
        "message": caption,
        "access_token": access_token
    }
    response = requests.post(url, data=data)
    return response.json()

print("ğŸŸ¢ Scheduler Ä‘ang cháº¡y... Kiá»ƒm tra bÃ i viáº¿t má»—i 60 giÃ¢y.")

while True:
    now = datetime.now()
    updated_rows = []

    try:
        with open(CSV_FILE, "r", encoding="utf-8") as f:
            reader = csv.reader(f)
            rows = list(reader)
    except Exception as e:
        print("âŒ KhÃ´ng thá»ƒ Ä‘á»c file CSV:", e)
        time.sleep(60)
        continue

    for row in rows:
        try:
            if len(row) < 10:
                print("âš ï¸ Bá» qua dÃ²ng khÃ´ng Ä‘á»§ cá»™t:", row)
                updated_rows.append(row)
                continue

            # Láº¥y Ä‘Ãºng 10 cá»™t
            product, keywords, platform, time_str, token, page_id, mode, date_str, caption, image_path = row[:10]

            scheduled_time = datetime.strptime(f"{date_str} {time_str}", "%Y-%m-%d %H:%M")

            print(f"\nğŸ“„ Äang xÃ©t bÃ i: {product} ({platform}) - {scheduled_time}")
            print(f"ğŸ•’ Hiá»‡n táº¡i: {now.strftime('%Y-%m-%d %H:%M')}")

            if platform.strip().lower() == "facebook" and now >= scheduled_time:
                print("ğŸš€ Äang Ä‘Äƒng bÃ i lÃªn Facebook...")
                result = post_caption_to_facebook(page_id.strip(), token.strip(), caption.strip())
                print("âœ… ÄÃ£ Ä‘Äƒng:", result)
            else:
                updated_rows.append(row)

        except Exception as e:
            print("âŒ Lá»—i khi xá»­ lÃ½ dÃ²ng:", row)
            print(e)
            updated_rows.append(row)

    # Ghi láº¡i nhá»¯ng bÃ i chÆ°a Ä‘áº¿n giá»
    try:
        with open(CSV_FILE, "w", encoding="utf-8", newline="") as f:
            writer = csv.writer(f)
            writer.writerows(updated_rows)
    except Exception as e:
        print("âŒ KhÃ´ng thá»ƒ ghi láº¡i file CSV:", e)

    time.sleep(60)
