import csv
import time
import requests
from datetime import datetime

CSV_FILE = "scheduled_posts.csv"

def post_caption_to_facebook(page_id, access_token, caption):
    url = f"https://graph.facebook.com/v19.0/{page_id}/feed"
    data = {
        "message": caption,
        "access_token": access_token
    }
    response = requests.post(url, data=data)
    return response.json()

while True:
    now = datetime.now()
    updated_rows = []

    with open(CSV_FILE, "r", encoding="utf-8") as f:
        reader = csv.reader(f)
        rows = list(reader)

    for row in rows:
        try:
            (product, keywords, platform, time_str, token, page_id, mode, date_str, caption, image_path) = row
            scheduled_time = datetime.strptime(f"{date_str} {time_str}", "%Y-%m-%d %H:%M")
            if platform == "Facebook" and now >= scheduled_time:
                res = post_caption_to_facebook(page_id, token, caption)
                print("✅ Đã đăng:", res)
            else:
                updated_rows.append(row)
        except Exception as e:
            print("❌ Lỗi xử lý dòng:", row)
            print(e)
            updated_rows.append(row)

    # Ghi lại file (xoá bài đã đăng)
    with open(CSV_FILE, "w", encoding="utf-8", newline="") as f:
        writer = csv.writer(f)
        writer.writerows(updated_rows)

    time.sleep(60)  # kiểm tra mỗi 1 phút
