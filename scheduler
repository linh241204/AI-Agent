# scheduler.py
import csv
import time
import requests
from datetime import datetime

def post_to_facebook(message, page_id, access_token):
    url = f"https://graph.facebook.com/{page_id}/feed"
    data = {"message": message, "access_token": access_token}
    r = requests.post(url, data=data)
    return r.status_code == 200, r.text

print("ğŸš€ Äang cháº¡y Scheduler...\n")

while True:
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    remaining_rows = []

    try:
        with open("scheduled_posts.csv", "r", encoding="utf-8") as f:
            reader = csv.reader(f)
            for row in reader:
                if len(row) < 6:
                    continue
                caption, platform, scheduled_time, token, page_id, mode = row
                if scheduled_time == now and mode == "ğŸ“… Tá»± Ä‘á»™ng Ä‘Äƒng Ä‘Ãºng giá»":
                    print(f"â° {now} - Äang Ä‘Äƒng bÃ i...")
                    success, resp = post_to_facebook(caption, page_id, token)
                    if success:
                        print("âœ… ÄÃ£ Ä‘Äƒng bÃ i thÃ nh cÃ´ng")
                    else:
                        print(f"âŒ Lá»—i khi Ä‘Äƒng bÃ i: {resp}")
                else:
                    remaining_rows.append(row)

        with open("scheduled_posts.csv", "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerows(remaining_rows)

    except FileNotFoundError:
        print("ğŸ“‚ ChÆ°a cÃ³ file scheduled_posts.csv. Äá»£i bÃ i má»›i...")

    time.sleep(60)
