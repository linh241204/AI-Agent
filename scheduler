import csv
import time
from datetime import datetime
import requests
import streamlit as st

# ====== Äá»c access token & page ID tá»« secrets ======
FB_PAGE_TOKEN = st.secrets["FB_PAGE_TOKEN"]
FB_PAGE_ID = st.secrets["FB_PAGE_ID"]

# ====== HÃ m Ä‘Äƒng bÃ i lÃªn Facebook ======
def post_to_facebook(image_url, caption):
    url = f"https://graph.facebook.com/v18.0/{FB_PAGE_ID}/photos"
    payload = {
        "url": image_url,
        "caption": caption,
        "access_token": FB_PAGE_TOKEN
    }
    res = requests.post(url, data=payload)
    return res.json()

# ====== Cháº¡y kiá»ƒm tra Ä‘á»‹nh ká»³ ======
print("ğŸ“¡ Báº¯t Ä‘áº§u kiá»ƒm tra lá»‹ch Ä‘Äƒng...")

while True:
    try:
        now = datetime.now()
        updated_rows = []

        with open("scheduled_posts.csv", "r", encoding="utf-8") as f:
            reader = csv.reader(f)
            for row in reader:
                if len(row) != 10:
                    continue  # bá» qua dÃ²ng lá»—i

                product, keywords, platform, time_str, token, page_id, mode, date_str, caption, image_url = row
                scheduled_time = datetime.strptime(f"{date_str} {time_str}", "%Y-%m-%d %H:%M")

                if scheduled_time <= now:
                    print(f"ğŸš€ ÄÄƒng bÃ i: {caption[:30]}...")
                    result = post_to_facebook(image_url, caption)
                    print("âœ… Káº¿t quáº£:", result)
                else:
                    updated_rows.append(row)  # chÆ°a Ä‘áº¿n giá» â†’ giá»¯ láº¡i

        # Ghi láº¡i file, giá»¯ cÃ¡c bÃ i chÆ°a Ä‘Äƒng
        with open("scheduled_posts.csv", "w", encoding="utf-8", newline="") as f:
            writer = csv.writer(f)
            writer.writerows(updated_rows)

    except Exception as e:
        print("âŒ Lá»—i khi xá»­ lÃ½ lá»‹ch Ä‘Äƒng:", e)

    time.sleep(60)  # kiá»ƒm tra má»—i phÃºt
