import csv
import time
import requests
from datetime import datetime

CSV_FILE = "scheduled_posts.csv"

def post_to_facebook(caption, image_path, page_id, access_token):
    url = f"https://graph.facebook.com/v19.0/{page_id}/photos"
    with open(image_path, "rb") as img:
        files = {"source": img}
        data = {
            "caption": caption,
            "access_token": access_token
        }
        response = requests.post(url, files=files, data=data)
        return response.json()

while True:
    now = datetime.now()
    new_rows = []
    with open(CSV_FILE, "r", encoding="utf-8") as f:
        reader = csv.reader(f)
        rows = list(reader)

    for row in rows:
        try:
            (product, keywords, platform, time_str, token, page_id, mode, date_str, caption, image_path) = row
            scheduled_time = datetime.strptime(f"{date_str} {time_str}", "%Y-%m-%d %H:%M")
            if now >= scheduled_time:
                if platform == "Facebook":
                    res = post_to_facebook(caption, image_path, page_id, token)
                    print(f"✅ Đã đăng: {res}")
                else:
                    print("⚠️ Hiện chỉ hỗ trợ đăng Facebook.")
            else:
                new_rows.append(row)
        except Exception as e:
            print("❌ Lỗi khi xử lý dòng:", row)
            print(e)

    with open(CSV_FILE, "w", encoding="utf-8", newline="") as f:
        writer = csv.writer(f)
        writer.writerows(new_rows)

    time.sleep(60)  # kiểm tra mỗi phút
