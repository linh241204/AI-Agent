import csv
import time
from datetime import datetime
import requests
import streamlit as st

# ====== Đọc access token & page ID từ secrets ======
FB_PAGE_TOKEN = st.secrets["FB_PAGE_TOKEN"]
FB_PAGE_ID = st.secrets["FB_PAGE_ID"]

# ====== Hàm đăng bài lên Facebook ======
def post_to_facebook(image_url, caption):
    url = f"https://graph.facebook.com/v18.0/{FB_PAGE_ID}/photos"
    payload = {
        "url": image_url,
        "caption": caption,
        "access_token": FB_PAGE_TOKEN
    }
    res = requests.post(url, data=payload)
    return res.json()

# ====== Chạy kiểm tra định kỳ ======
print("📡 Bắt đầu kiểm tra lịch đăng...")

while True:
    try:
        now = datetime.now()
        updated_rows = []

        with open("scheduled_posts.csv", "r", encoding="utf-8") as f:
            reader = csv.reader(f)
            for row in reader:
                if len(row) != 10:
                    continue  # bỏ qua dòng lỗi

                product, keywords, platform, time_str, token, page_id, mode, date_str, caption, image_url = row
                scheduled_time = datetime.strptime(f"{date_str} {time_str}", "%Y-%m-%d %H:%M")

                if scheduled_time <= now:
                    print(f"🚀 Đăng bài: {caption[:30]}...")
                    result = post_to_facebook(image_url, caption)
                    print("✅ Kết quả:", result)
                else:
                    updated_rows.append(row)  # chưa đến giờ → giữ lại

        # Ghi lại file, giữ các bài chưa đăng
        with open("scheduled_posts.csv", "w", encoding="utf-8", newline="") as f:
            writer = csv.writer(f)
            writer.writerows(updated_rows)

    except Exception as e:
        print("❌ Lỗi khi xử lý lịch đăng:", e)

    time.sleep(60)  # kiểm tra mỗi phút
