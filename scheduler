with tab1:
    st.header("📝 Tạo nội dung bài đăng")
    product_name = st.text_input("Tên sản phẩm")
    keywords = st.text_input("Từ khóa", "gốm, thủ công, mộc mạc, decor")
    platform = st.selectbox("Nền tảng", ["Facebook", "Instagram", "Threads"])

    mode = st.radio("Chế độ đăng", ["📅 Tự động đúng giờ", "🤖 Tự động đăng đa dạng mỗi ngày", "👀 Chờ duyệt thủ công"])

    if mode == "📅 Tự động đúng giờ":
        date = st.date_input("📅 Ngày đăng", datetime.today())
        time = st.time_input("⏰ Giờ đăng", datetime.now().time())
        post_time = datetime.combine(date, time)

    elif mode == "🤖 Tự động đăng đa dạng mỗi ngày":
        start_date = st.date_input("📅 Ngày bắt đầu", datetime.today())
        end_date = st.date_input("📅 Ngày kết thúc", datetime.today() + timedelta(days=7))
        post_time = st.time_input("⏰ Giờ đăng mỗi ngày", datetime.now().time())

    if st.button("✨ Xử lý bài đăng"):
        if not product_name or not keywords:
            st.warning("⚠️ Vui lòng nhập đủ thông tin.")

        elif mode == "📅 Tự động đúng giờ":
            with open("scheduled_posts.csv", "a", encoding="utf-8", newline="") as f:
                writer = csv.writer(f)
                writer.writerow([
                    product_name,
                    keywords,
                    platform,
                    post_time.strftime("%H:%M"),
                    os.getenv("FB_PAGE_TOKEN"),
                    os.getenv("FB_PAGE_ID"),
                    "once"
                ])
            st.success(f"📅 Đã lên lịch đăng vào {post_time.strftime('%d/%m/%Y %H:%M')}")

        elif mode == "🤖 Tự động đăng đa dạng mỗi ngày":
            current_day = start_date
            while current_day <= end_date:
                auto_caption = generate_caption(product_name, keywords, platform)
                with open("scheduled_posts.csv", "a", encoding="utf-8", newline="") as f:
                    writer = csv.writer(f)
                    writer.writerow([
                        product_name,
                        keywords,
                        platform,
                        post_time.strftime("%H:%M"),
                        os.getenv("FB_PAGE_TOKEN"),
                        os.getenv("FB_PAGE_ID"),
                        "daily",
                        auto_caption.replace("\n", " ")
                    ])
                current_day += timedelta(days=1)
            st.success(f"🤖 Đã lên lịch tự động tạo & đăng bài từ {start_date} đến {end_date} lúc {post_time.strftime('%H:%M')}")

        else:
            caption = generate_caption(product_name, keywords, platform)
            st.text_area("📋 Nội dung đề xuất", caption, height=150)
            st.session_state.posts.append({
                "id": str(uuid.uuid4())[:8],
                "product": product_name,
                "platform": platform,
                "caption": caption,
                "time": "chờ duyệt",
                "likes": 0, "comments": 0, "shares": 0, "reach": 0
            })
            st.success("✅ Đã lưu bài viết để bạn duyệt & đăng sau!")

    if st.session_state.posts:
        st.markdown("### 📑 Danh sách bài đăng chờ duyệt")
        st.dataframe(pd.DataFrame(st.session_state.posts))
    else:
        st.info("Chưa có bài viết nào.")
